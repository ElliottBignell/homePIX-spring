<!DOCTYPE html>

<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"th:replace="~{fragments/layout :: layout (~{::body},'albums')}">

<body onload="initMap()">

<script th:src="@{resources/js/navigation.js}" type="text/javascript" async=""></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMTn_xDVuQaTSTSqCbp01M0yH7eKqzP3c"></script>
<script th:inline="javascript">
  function initMap() {

      var mapOptions = {
          zoom: 14,
          center: {lat: [[${refLatitude}]], lng: [[${refLongitude}]]}
      };

      var map = new google.maps.Map(document.getElementById('map'), mapOptions);

      // Reference marker
      var referenceMarker = new google.maps.Marker({
          position: {lat: [[${refLatitude}]], lng: [[${refLongitude}]]},
          map: map,
          title: 'Reference picture'
      });

      var infoWindow = new google.maps.InfoWindow({
          content: '<h3>Picture by E.C. Bignell</h3>'
      });

      referenceMarker.addListener('click', function() {
          infoWindow.open(map, referenceMarker);
      });

      // Get the nearby coordinates from the div and parse them
      var nearbyCoordinatesDivs = document.querySelectorAll('#nearby-coordinates div');
      var nearbyCoordinates = [];

      nearbyCoordinatesDivs.forEach(function(div) {

          // Get the text, remove brackets, split by comma, and convert to floats
          var text = div.textContent.replace(/[\[\]]/g, ''); // Removes brackets
          var coordParts = text.split(','); // Split by comma
          var lat = parseFloat(coordParts[0]);
          var lng = parseFloat(coordParts[1]);
          var id = coordParts[2];
          var caption = coordParts[3];
          var filename = coordParts[4];

          // Push the parsed coordinates into the array
          nearbyCoordinates.push({lat: lat, lng: lng, caption: caption, id: id });
      });

      // Add markers for each nearby coordinate
      nearbyCoordinates.forEach(function(coord) {

          var marker = new google.maps.Marker({
              position: coord,
              map: map,
              title: coord.caption,
              id: coord.id
          });

          console.log("Marker");

          var infoWindow = new google.maps.InfoWindow({
              content: '<h3>' + coord.caption + '</h3><a href="https://www.homepix.ch/collection/' + coord.id + '">' + coord.caption + '</a>'
          });
          console.log("Infor Window");

          // Show info window when the marker is clicked
          marker.addListener('click', function() {
              infoWindow.open(map, marker);
          });
          console.log("Event handler");
      });
    }
</script>

<link rel="stylesheet" th:href="@{/resources/css/clearall.css}" />
<link rel="stylesheet" th:href="@{/resources/css/dropdown.css}" />

<div class="techfont" style="position:absolute;left:0px;width:100vw;height:100vh;">
  <div id="details" style="position:absolute;left:0px;width:100vw;height:100vh;">
    <c th:if="${errorMessage != null}">
      <div style="position:absolute;top:10em;left:10em;">
        <h1>Picture File</h1>
        <h2>Error page!</h2>
        <div th:text="${errorMessage}">
        </div>
      </div>
    </c>
    <div id="frame" class="homepix-picture-standalone" style="display:block;">
      <div id="map"  style="display:block;height: 100vh; width: 100vw;"></div>
    </div>

    <div id="nearby-coordinates" style="display: none;">
      <div th:each="pic : ${nearbyPictures}" th:text="@{[__${pic.latitude}__,__${pic.longitude}__,__${pic.id}__,'__${pic.title}__',__${pic.filename}__]}">
      </div>
    </div>
  </div>

</div>

</body>
</html>
